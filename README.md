# solidus_klaviyo

This extension allows you to integrate your [Solidus](https://solidus.io) store with
[Klaviyo](https://klaviyo.com).

## Installation

Add solidus_klaviyo to your Gemfile:

```ruby
gem 'solidus_klaviyo'
```

Bundle your dependencies and run the installation generator:

```console
$ bundle
$ bundle exec rails g solidus_klaviyo:install
```

The generator will create an initializer at `config/initializers/solidus_klaviyo.rb` with the
default configuration. Take a look at the file and customize it to fit your environment.

## Usage

The extension will send the following events to Klaviyo:

- `Started Checkout`: when an order transitions from the `cart` state to `address`.
- `Placed Order`: when an order is finalized.
- `Ordered Product`: for each item in a finalized order.

For the full payload of these events, look at the source code of the serializers and events.

### Implementing custom events

If you have custom events you want to track with this gem, you can easily do so by creating a new
event class and implementing the required methods:

```ruby
module MyApp
  module KlaviyoEvents
    class SignedUp < SolidusKlaviyo::Event::Base
      def name
        'Signed Up'
      end

      def email
        user.email
      end

      def customer_properties
        SolidusKlaviyo::Serializer::Customer.serialize(user)
      end

      def properties
        {
          '$event_id' => user.id.to_s,
          '...' => '...',
        }
      end

      def time
        user.created_at
      end

      private

      def user
        payload.fetch(:user)
      end
    end 
  end 
end
```

Once you have created the class, the next step is to register your custom event when initializing
the extension:

```ruby
# config/initializers/solidus_klaviyo.rb
SolidusKlaviyo.configure do |config|
  config.events['signed_up'] = MyApp::KlaviyoEvents::SignedUp
end
```

Your custom event is now properly configured! You can track it by enqueuing the `TrackEventJob`:

```ruby
SolidusKlaviyo::TrackEventJob.perform_later('signed_up', user: user)
```

*NOTE:* You can follow the same exact pattern to override the built-in events.

## Development

### Testing the extension

First bundle your dependencies, then run `bin/rake`. `bin/rake` will default to building the dummy
app if it does not exist, then it will run specs. The dummy app can be regenerated by using
`bin/rake extension:test_app`.

```console
$ bundle
$ bin/rake
```

To run [Rubocop](https://github.com/bbatsov/rubocop) static code analysis run

```console
$ bundle exec rubocop
```

When testing your application's integration with this extension you may use its factories.
Simply add this require statement to your spec_helper:

```ruby
require 'solidus_klaviyo/factories'
```

### Running the sandbox

To run this extension in a sandboxed Solidus application, you can run `bin/sandbox`. The path for
the sandbox app is `./sandbox` and `bin/rails` will forward any Rails commands to
`sandbox/bin/rails`.

Here's an example:

```console
$ bin/rails server
=> Booting Puma
=> Rails 6.0.2.1 application starting in development
* Listening on tcp://127.0.0.1:3000
Use Ctrl-C to stop
```

### Releasing new versions

Your new extension version can be released using `gem-release` like this:

```console
$ bundle exec gem bump -v VERSION --tag --push --remote upstream && gem release
```

## License

Copyright (c) 2020 Nebulab Srls, released under the New BSD License.
